#!/usr/bin/env bash
set -euo pipefail
trap 'exit 1' SIGPIPE

for cmd in grim slurp satty; do
  command -v "$cmd" >/dev/null 2>&1 || { echo "$cmd not found" >&2; exit 1; }
done

GEOM="$(slurp)" || exit 1

if command -v ffmpeg >/dev/null 2>&1 && ffmpeg -filters 2>/dev/null | grep -q tonemap; then
  grim -g "$GEOM" - \
    | ffmpeg -hide_banner -loglevel error -f image2pipe -i - \
      -vf "tonemap=tonemap=hable:desat=0,format=rgb24" -f png - - \
    | satty -f -
  exit 0
fi

if command -v magick >/dev/null 2>&1; then
  grim -g "$GEOM" - | magick - -colorspace sRGB png:- | satty -f -
  exit 0
fi

# last resort: raw PNG
grim -g "$GEOM" - | satty -f -